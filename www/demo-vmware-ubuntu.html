<html>
<head>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<title>Zumastor Walkthroughs</title>
</head>
<body>

<h1>Kicking Zumastor's tires with VMware</h1>

<h2>Installation</h2>
First, install vmware player on your machine.  (If you're using Ubuntu,
it might be as simple as <tt>apt-get install vmware-player</tt>.)
<p>
Second, download a vmware image with Ubuntu preinstalled.
I'm not sure what the best is, but the oddly-named site 
<a href="http://www.thoughtpolice.co.uk/vmware">www.thoughtpolice.co.uk/vmware</a>
seems reasonable.  
<p>
Choose the Ubuntu Server 6.06 download, click
on the "fast torrent!" link, and tell Firefox to open the torrent file;
this should pop up kTorrent to download the 189 megabyte image.
The image is several files zipped together, so unpack it with
<pre>
$ mkdir ~/vmubuntu
$ cd ~/vmubuntu
$ unzip ~/ubuntu-server-6.06-i386.zip
</pre>
<p>
Third, start up vmware player (Applications / System Tools / VMWare Player)
and tell it to load the .vmx file in the directory where you unpacked the vmware image.
<p>
Fourth, inside vmware, log in to the virtual ubuntu box (using the username and password
from the site where you downloaded the image).
<p>
Fifth, inside vmware, download and install dmsetup and the Zumastor packages, e.g.
<pre>
$ sudo apt-get install dmsetup
$ wget -m -np zumastor.org/downloads/snapshots/0.5-r1004
$ mv zumastor.org/downloads/snapshots/0.5-r1004 .
$ rm -rf zumastor.org
$ sudo dpkg -i 0.5-r1004/*.deb
</pre>
(This currently fails with Ubuntu 7.10, which is why this walkthrough uses 6.06.)
The install takes several minutes.
Ignore the warnings about deleting symbolic links '.../build' and '.../source'.
<p>
Sixth, halt the virtual machine:
<pre>
$ sudo halt
</pre>
Seventh, work around a problem with VMWare and newer kernels by
editing the file ubuntu-server-6.06.1-i386.vmx to replace line 4,
<pre>
scsi0.virtualDev = "lsilogic"
</pre>
with
<pre>
scsi0.virtualDev = "buslogic"
</pre>
(thanks to Chris Smith, who found this tidbit in
<a href="http://gentoo-wiki.com/HOWTO_Install_Gentoo_on_VMware">Gentoo's VMware documentation</a>).
<p>
Eighth, boot the virtual machine again.  (If booting fails with
the error "Unable to find volume group 'Ubuntu'", perhaps you
skipped step seven?)
<p>
Congratulations, you now have a virtual system with Zumastor installed!

<h2>Configuration</h2>
Now that you have Zumastor installed and booted, it's time to
try creating a volume and playing with snapshots.
<p>
Since the image we booted doesn't have any unpartitioned space,
and there's no online shrink for ext3, let's fake it
by creating an LVM volume group in a regular file.
We're just playing around, so just allocate 200MB plus change:
<pre>
$ sudo su
# dd if=/dev/zero of=/media/vg.img bs=1024 count=220000
# losetup /dev/loop/0 /media/vg.img
# pvcreate /dev/loop/0
# vgcreate sysvg /dev/loop/0
# lvcreate --name test --size 100MB sysvg
# lvcreate --name test_snap --size 100MB sysvg
# zumastor define volume zumatest /dev/sysvg/test /dev/sysvg/test_snap --initialize
</pre>
You now have a zumastor block device at /dev/mapper/zumatest.
Let's create a filesystem and configure periodic snapshots:
<pre>
# mkfs.ext3 /dev/mapper/zumatest
# zumastor define master zumatest --hourly 24
# df | grep zumatest
Filesystem           1K-blocks   Used Available Use% Mounted on
<b>/dev/mapper/zumatest  99150    4127   89903   5% /var/run/zumastor/mount/zumatest</b>
</pre>
Setting this volume as a "master" causes it be to mounted on /var/run/zumastor/mount/zumatest
The "--hourly 24" specifies that we want to keep the 24 most recent hourly snapshots (a days worth).
A snapshot will be created once an hour via the zumastor hourly cron
script.  We can accelerate this by manually telling zumastor to take an
"hourly" snapshot, with the <tt>zumastor snapshot</tt> command:

<pre>
# zumastor snapshot zumatest hourly
# df | grep zumatest
/dev/mapper/zumatest  99150    4127   89903   5% /var/run/zumastor/mount/zumatest
<b>/dev/mapper/zumatest(0)  99150    4127   89903   5% /var/run/zumastor/mount/zumatest(0)</b>
</pre>
The snapshot you created manually is snapshot #0, 
and is mounted at <code>/var/run/zumastor/mount/zumatest(0)</code>.
<p>
Note:  You do <i>not</i> need to add the filesystem to your /etc/fstab.
The zumastor init script will mount the volume and all its snapshots
automatically at boot time.
<p>

Now do some IO on the filesystem, then look at df again:
<pre>
# echo "This is the first file!" > /var/run/zumastor/zumatest/foo.txt
# df | grep zumatest
/dev/mapper/zumatest  99150    <b>4128   89902</b>   5% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  99150    4127   89903   5% /var/run/zumastor/mount/zumatest(0)
</pre>

As expected, the origin's "Used" block count goes up by one,
but the snapshot's doesn't change.
<p>
Now take another snapshot, and look at df again:
<pre>
# zumastor snapshot zumatest hourly
# df | grep zumatest
/dev/mapper/zumatest  99150    4128   89902   5% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  99150    4127   89903   5% /var/run/zumastor/mount/zumatest(0)
<b>/dev/mapper/zumatest(2)  99150    4128   89902   5% /var/run/zumastor/mount/zumatest(0)</b>
</pre>
Notice that the first snapshot was named 
<code>zumatest(0)</code>, but the new one is named <code>zumatest(2)</code>.
(Why the gap?  Zumastor uses another snapshot internally during
replication.  Yes, this is a bit of a rough edge.)
<p>
So far, so good.  Now, let's see how many snapshots we can take.
Here's a loop that takes fifty in quick succession.
Run it, then use df to see how many snapshots are around afterwards:
<pre>
# num=0
# while test $num -lt 50
  do 
    zumastor snapshot zumatest hourly
    num=`expr $num + 1`
    echo $num
  done
# df -P | grep zumatest
</pre>
You should see 24 snapshots (the limit set when we did the <tt>zumastor define master</tt>)
plus the origin volume.  Each time you run 'zumastor snapshot ...'
it creates a new snapshot, and deletes any that are 'too old'.
<p>
Now reboot the virtual machine and log back in as root.  
Notice that 'df' doesn't show any Zumastor snapshots.
That's because when Zumastor started at boot time, it
couldn't see the loopback device, because we didn't arrange 
for it to be set up automatically at boot time.  
(This won't happen with real devices!)
So do it manually now, then tell LVM about it, then tell Zumastor about it:
<pre>
$ sudo sh
# losetup /dev/loop/0 /media/vg.img
# vgchange -ay
# bash /etc/init.d/zumastor restart
# df | grep zumatest
</pre>
You should now see the same volume and set of snapshots that you did before.
<p>
If vgchange -ay doesn't detect your volume group, do <tt>rm /etc/lvm/.cache</tt>
and try again.

<center>&copy; 2007 Google</center>
</body>
</html>
