<html>
<head>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<title>Zumastor Walkthroughs</title>
</head>
<body>

<h1>Zumastor Walkthroughs</h1>

<h2>Ubuntu walkthrough on QEMU</h2>
First, install qemu on your machine.  (If you're using Ubuntu,
it might be as simple as <tt>apt-get install qemu</tt>.)
<p>

Second, download an Ubuntu or Debian installation CD image.  Use one
of the more complete images if you don't want to configure network
access for the test image.  Ubuntu/dapper is what we build and test
against, anything newer should also work: <a
href="http://mirrors.kernel.org/ubuntu-releases/dapper/ubuntu-6.06.1-server-i386.iso">http</a>
or <a
href="http://torrent.ubuntu.com:6969/file?info_hash=%0F%EF%D4K%9DW%B9%99w%0A%00%DB%60%21%CF%EBV%87%7Bq">torrent</a>.

<p>

Create an empty file to become the image's block device using either dd or qemu-img.
<p>

<code>
dd if=/dev/zero bs=1M seek=10k count=0 of=zumastor.raw
</code>
<p>

Start qemu, booting from CD the first time to install a base system.
There will be several questions depending on the installation CD
chosen.
<p>

<code>
qemu -cdrom ubuntu-6.06.1-server-i386.iso -hda zumastor.raw -boot d
</code>
<p>

Chose manual partitioning, create a 2G partition for / on /dev/sda and
leave the rest unallocated.  You may or may not want a 1G swap.
Create any user you wish and remember the password.

<p>

Boot again off the newly install disk image, this time with userspace
networking enabled.
<p>

<code>
qemu -cdrom ubuntu-6.06.1-server-i386.iso -hda zumastor.raw -boot c -net user -net nic
</code>
<p>

Log in using the username and password used during installation,
become root, and begin installing dependencies.

<pre>
$ sudo apt-get install elinks dmsetup
$ mkdir tmp
$ cd tmp
$ links zumastor.org
[download the kernel image, zumastor, and ddsnap packages.  Don't forget to let the downloads finish!]
$ sudo dpkg -i *.deb
</pre>
(This currently fails with Ubuntu 7.10, which is why this walkthrough uses 6.06.)
Ignore the warnings about deleting symbolic links.
<p>
Reboot the virtual machine:
<pre>
$ sudo reboot
</pre>

<pre>
$ sudo su
Password:
# pvcreate /dev/hda3
  Physical volume "/dev/hda3" successfully created
# vgcreate sysvg /dev/hda3
  Volume group "sysvg" successfully created
# lvcreate --name origin --size 5G sysvg
  Logical volume "origin" created
# lvcreate --name snapstore --size 5G sysvg
  Logical volume "snapstore" created
# zumastor define volume zumatest /dev/sysvg/origin /dev/sysvg/snapstore --initialize
Wed Nov 21 19:32:58 2007: [3622] snap_server_setup: ddsnapd bound to socket /var/run/zumastor/servers/zumatest
pid = 3623
Successfully created and initialized volume 'zumatest'.
You can no create a filesystem on /dev/mapper/zumatest
</pre>

You now have a zumastor ddsnap block device at <code>/dev/mapper/zumatest</code>, which can be snapshotted.
Lets create a filesystem, and configure some periodic snapshots:

<pre>
# mkfs.ext3 /dev/mapper/zumatest
mke2fs 1.38 (30-Jun-2005)
...
# zumastor define master zumatest --hourly 24
# df
...
/dev/mapper/zumatest  5160576    131228   4767204   3% /var/run/zumastor/mount/zumatest
#
</pre>

Setting this volume as a "master" causes it be to mounted on /var/run/zumastor/mount/zumatest
The "--hourly 24" specifies that we want to keep the 24 most recent hourly snapshots (a days worth).
A snapshot will be created once an hour via the zumastor hourly cron script.  We can accelerate this by manually telling zumastor to take an "hourly" snapshot.

<pre>
# zumastor snapshot zumatest hourly
# df | grep zumatest
/dev/mapper/zumatest  5160576    131228   4767204   3% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  5160576    131228   4767204   3% /var/run/zumastor/mount/zumatest(0)
</pre>

If you do some IO on the filesystem you will notice only the origin device, mounted on <code>/var/run/zumastor/mount/zumatest</code> changes.
<hr>
<center>&copy; 2007 Google</center>
</body>
</html>

