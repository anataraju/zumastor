<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 7.0.4" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a { color: blue; }
a:visited { color: fuchsia; }

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 2px solid silver;
}
h2 {
  border-bottom: 2px solid silver;
  padding-top: 0.5em;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.2em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}
div.quoteblock .attribution {
  text-align: right;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
ol.olist2 {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}
</style>
<title>Zumastor HOWTO</title>
</head>
<body>
<div id="header">
<h1>Zumastor HOWTO</h1>
<span id="author">Dan Kegel</span><br />
<span id="email"><tt>&lt;<a href="mailto:dank@kegel.com">dank@kegel.com</a>&gt;</tt></span><br />
<span id="revision">version 0.0,</span>
Dec 2007
</div>
<h2>1. Introduction</h2>
<div class="sectionbody">
<p>This document will explain what Zumastor is, how it differs from
other snapshot and replication tools, how to install it,
and how to use it.</p>
</div>
<h2>2. What is Zumastor?</h2>
<div class="sectionbody">
<p>It has been difficult to convince users of commercial NAS applicances
to switch to Linux.  In particular, some commercial NAS boxes have
had better support for snapshots and remote replication than Linux does.
Zumastor is an effort to fix that.</p>
<h3>2.1. Snapshots</h3>
<p>Snapshots can be useful as part of an hourly backup system.  Instead of
shutting down all applications for the entire duration of the backup, you
can shut them down for just the second or two needed to take a snapshot.</p>
<p>If your goal is to protect users from accidental deletion of files,
you may want to take snapshots every hour, and leave the last few
snapshots around; users who accidentally delete a file can just look in
the snapshot.</p>
<p>LVM already lets administrators create snapshots, but its design has the
surprising property that every block you change on the original volume
consumes one block for each snapshot.  The resulting speed and space
penalty usually makes the use of more than one or two snapshots at a
time impractical.</p>
<p>Zumastor keeps all snapshots for a particular volume in a common snapshot
store, and shares blocks the way one would expect.  Thus making a
change to one block of a file in the original volume only uses one block
in the snapshot store no matter how many snapshots you have.</p>
<h3>2.2. Remote Replication</h3>
<p>Andrew Tridgell's rsync is a wonderful tool for replicating files remotely.
However, when doing periodic replication of large numbers of
infrequently changing files, the overhead for figuring out what files
need to be sent can be extreme.</p>
<p>Zumastor keeps track of which block change between one snapshot
and the next, and can easily send just the changed blocks.
Thus Zumastor can do periodic replication of large filesystems much more
efficiently than rsync can.</p>
</div>
<h2>3. License</h2>
<div class="sectionbody">
<p>Zumastor is licensed under GPLv2.</p>
</div>
<h2>4. Development</h2>
<div class="sectionbody">
<p>Zumastor development happens on an svn repository, mailing list, irc
channel, and issue tracker linked to from our home page at
<a href="http://zumastor.org">http://zumastor.org</a>.</p>
<p>Most development is done by a small group of contributors
(Daniel Phillips, Jiaying Zhang, Shapor Naghibzadeh, Dan Kegel, Drake Diedrich, Frank Mayhar, and Chris Smith), but we welcome patches from the community.
(Jonathan Van Eenwyk contributed a cool offline backup feature,
but <a href="http://www.nomorevoid.com/downloads/dm-ddloop.tar.gz">his patch</a> has not yet been merged.  Let us know if you need this.)</p>
</div>
<h2>5. Status</h2>
<div class="sectionbody">
<p>Zumastor has a stable release (0.4) which is limited (e.g. only supports 2TB
volumes) but very stable.  We are focusing on documentation
and user feedback now, and hope to have the 0.5 stable release
out soon.  Please download and test the 0.5 snapshots and give us feedback
via the issue tracker, mailing list, or IRC channel at <a href="http://zumastor.org">http://zumastor.org</a>.</p>
<p>We have a number of kernel patches, and will push them upstream as
soon as possible.  See <a href="http://zumastor.org">http://zumastor.org</a> for a list.</p>
</div>
<h2>6. Limitations</h2>
<div class="sectionbody">
<h3>6.1. Volume Size</h3>
<p>We have verified that Zumastor can handle 1TB volumes.
As of 0.5-r997, it should be able to handle volumes of dozens of terabytes.
We are now verifying that it can handle 3TB volumes.
See <a href="http://code.google.com/p/zumastor/issues/detail?id=10">bug 10</a>.</p>
<h3>6.2. Snapshot Count</h3>
<p>Each volume can have at most 64 snapshots.  This limit may
be raised or removed in future releases; see <a href="http://code.google.com/p/zumastor/issues/detail?id=6">bug 6</a>.</p>
<h3>6.3. Performance</h3>
<p>On a single spindle, compared to a non-Zumastor volume, writes to an origin
volume under Zumastor can require six extra seeks, which
can be a significant performance penalty for some applications.
Multiple spindles and RAID controller caches can reduce this problem
significantly.  Reducing the number of seeks is a high priority goal for
future releases.
Until that happens, Zumastor is best suited for read-mostly applications.</p>
<h3>6.4. RAM</h3>
<p>Zumastor uses about 1MB of RAM per gigabyte of snapshot store to cache an internal index.
Having less RAM probably means Zumastor will perform poorly, but we have not measured this yet.
This may mean that adding a 10 terabyte volume to a system also requires adding several gigabytes of RAM for acceptable performance.</p>
<p>A future release may use a more compact index; see <a href="http://code.google.com/p/zumastor/issues/detail?id=5">bug 5</a>.</p>
</div>
<h2>7. Zumastor User Interface</h2>
<div class="sectionbody">
<p>Zumastor exposes itself to users in several ways:</p>
<ul>
<li>
<p>
An admin script, /etc/init.d/zumastor
</p>
</li>
<li>
<p>
A commandline tool, /bin/zumastor
</p>
</li>
<li>
<p>
Origin mount points, e.g. /var/mount/zumastor/myvolumename
</p>
</li>
<li>
<p>
Snapshot mount points, e.g. /var/mount/zumastor/myvolumename(10)
</p>
</li>
</ul>
<h3>7.1. Zumastor admin script</h3>
<p>The admin script, /etc/init.d/zumastor, simply starts or stops the
Zumastor daemon responsible for mounting Zumastor volumes.  Normally this
is run once at system startup time by init, but you may need to run it
manually in unusual circumstances.</p>
<p>For instance, if you tell Zumastor to use origin volumes or snapshot
stores on loopback devices that are not set up at boot time, and then
reboot, Zumastor can't mount them automatically; you have to set them up
and then restart Zumastor with the command <tt>/etc/init.d/zumastor restart</tt>.</p>
<h3>7.2. Zumastor commandline tool</h3>
<p>The sysadmin uses /bin/zumastor to configure snapshot stores,
take or delete snapshots, and set up remote replication.
See <a href="http://zumastor.org/man/zumastor.8.html">the zumastor man page</a> for more information.</p>
<p>The zumastor command is really just a very fancy wrapper around
the underlying command, ddsnap.  You probably won't ever need to
use ddsnap directly, but if you're curious, see <a href="http://zumastor.org/man/ddsnap.8.html">the ddsnap man page</a>.</p>
<h3>7.3. Origin and Snapshot mount points</h3>
<p>Zumastor deals with two kinds of volumes: <em>origin</em> volumes
and <em>snapshot</em> volumes.  Simply put, origin volumes are what you
take snapshots of.
Zumastor mounts these volumes for you in appropriately named
subdirectories of /var/mount/zumastor.
In other words, you do not need to add any of these to /etc/fstab.
The zumastor init script will mount the volume and all its snapshots
automatically at boot time.</p>
<p>Now do some IO on the filesystem, then look at df again:</p>
<p>Snapshot volumes have the same name as their origin volumes, but
with a snapshot number in parenthesis after it.
Zumastor skips one number each snapshot for housekeeping reasons, so
home(1000) would be roughly the 500th snapshot of home.
The snapshot number never decreases (though perhaps it would
wrap if you did billions of snapshots&#8230;)</p>
<p>Note: users would probably be happier if Zumastor used a different
convention for naming snapshots, e.g. volname-hourly-YYYY-MM-DD-HH:MM.
A future release of Zumastor might allow this.</p>
<p>Note: Zumastor always mounts all its volumes under /var/mount/zumastor.
This is fine for fileservers with no local users, as the volumes
will be mounted at the proper location on the NFS client,
but it's not so nice for e.g. desktops that just want to use Zumastor
to add snapshots to home directories.
A future release of Zumastor will make the mount points configurable
and improve local usability of snapshots.</p>
</div>
<h2>8. Installing Zumastor</h2>
<div class="sectionbody">
<p>Zumastor requires changes to the Linux kernel that are not yet
in the vanilla kernel, so a patched kernel is required.
You can install Zumastor on any recent distribution if you're
willing to do it by hand.  Automated installation is available
for Debian / Ubuntu and Gentoo.  (RHEL, Fedora, and Suse
are probably next on our list of distros to support, please
let us know if you're willing to contribute RPM .spec files.)
For developers, we also support automated installation with UML.</p>
<h3>8.1. Debian / Ubuntu</h3>
<p>Prebuilt kernel packages for recent Debian / Ubuntu systems
are available.
Stable releases are at <a href="http://zumastor.org/downloads/releases">http://zumastor.org/downloads/releases</a>,
and trunk snapshots are at <a href="http://zumastor.org/downloads/snapshots">http://zumastor.org/downloads/snapshots</a>.
The directories there are named by branch and svn revision,
e.g. 0.4-r999 is the 0.4 branch as of svn revision 999.
Once you've picked a version, download and install its four .deb
packages, along with dmsetup (which it depends on).  For instance:</p>
<div class="literalblock">
<div class="content">
<pre><tt>$ sudo apt-get install dmsetup
$ wget -m -np zumastor.org/downloads/snapshots/0.5-r1004
$ mv zumastor.org/downloads/snapshots/0.5-r1004 .
$ rm -rf zumastor.org
$ sudo dpkg -i 0.5-r1004/*.deb</tt></pre>
</div></div>
<p>The install takes several minutes.
Ignore the warnings about deleting symbolic links &#8230;/build and &#8230;/source.</p>
<p>You should probably play with it in a virtual environment
first.  (You can even do this on Windows!)</p>
<h4>8.1.1. Example: installing Zumastor on Ubuntu inside a VMWare player</h4>
<ol>
<li>
<p>
Install vmware player on your machine.  (If you're using Ubuntu,
it might be as simple as apt-get install vmware-player.)
</p>
</li>
<li>
<p>
Download a vmware image with Ubuntu preinstalled.  For instance, go to
<a href="http://www.thoughtpolice.co.uk/vmware">http://www.thoughtpolice.co.uk/vmware</a>,
choose the Ubuntu Server 6.06 download, click
on the "fast torrent!" link, and tell Firefox to open the torrent file;
this should pop up kTorrent to download the 189 megabyte image.
The image is several files zipped together, so unzip it before trying to use it (e.g. unzip ~/ubuntu-server-6.06-i386.zip).
</p>
</li>
<li>
<p>
Start up vmware player (Applications / System Tools / VMWare Player)
and tell it to load the .vmx file in the directory where you unpacked the vmware image.
</p>
</li>
<li>
<p>
Inside vmware, log in to the virtual ubuntu box
(using the username and password from the site where you downloaded the image).
</p>
</li>
<li>
<p>
Inside vmware, download and install dmsetup and the Zumastor packages
as described above.
</p>
</li>
<li>
<p>
Halt the virtual machine (e.g. sudo halt).
</p>
</li>
<li>
<p>
Work around a problem with VMWare and newer kernels by
editing the file ubuntu-server-6.06.1-i386.vmx to replace <em>lsilogic</em> on line 4 with <em>buslogic</em>.
(Thanks to <a href="http://gentoo-wiki.com/HOWTO_Install_Gentoo_on_VMware">the gentoo doc</a> for that tip.)
</p>
</li>
<li>
<p>
Boot the virtual machine again.  (If booting fails with
the error "Unable to find volume group <em>Ubuntu</em>", perhaps you
skipped step seven?)
</p>
</li>
</ol>
<p>Congratulations, you now have a virtual system with Zumastor installed!</p>
<h4>8.1.2. Example: installing Zumastor on Ubuntu inside a QEMU virtual machine</h4>
<ol>
<li>
<p>
Install qemu on your machine.  (If you're using Ubuntu,
it might be as simple as apt-get install qemu.)
</p>
</li>
<li>
<p>
Download an Ubuntu or Debian installation CD image.  Use one
of the more complete images if you don't want to configure network
access for the test image.  Here are links to download Ubuntu Dapper
via
<a href="http://mirrors.kernel.org/ubuntu-releases/dapper/ubuntu-6.06.1-server-i386.iso">http</a>
or
<a href="http://torrent.ubuntu.com:6969/file?info_hash=%0F%EF%D4K%9DW%B9%99w%0A%00%DB%60%21%CF%EBV%87%7Bq">torrent</a>.
</p>
</li>
<li>
<p>
Create an empty file to become the image's block device using either dd or qemu-img:
dd if=/dev/zero bs=1M seek=10k count=0 of=zqemu.raw
</p>
</li>
<li>
<p>
Start qemu, booting from CD the first time to install a base system:
qemu -cdrom ubuntu-6.06.1-server-i386.iso -hda zqemu.raw -boot d
</p>
</li>
<li>
<p>
Chose manual partitioning, create a 2G partition for / on /dev/sda and
leave the rest unallocated.  You may or may not want a 1G swap.
Create any user you wish and remember the password.
</p>
</li>
<li>
<p>
Boot again off the newly install disk image, this time with userspace
networking enabled:
qemu -cdrom ubuntu-6.06.1-server-i386.iso -hda zqemu.raw -boot c -net user -net nic
</p>
</li>
<li>
<p>
Log in to the virtual machine, and inside it, download and install dmsetup and the Zumastor packages
as described above.
</p>
</li>
<li>
<p>
Boot the virtual machine again.
</p>
</li>
</ol>
<p>Congratulations, you now have a virtual system with Zumastor installed!</p>
<h4>8.1.3. Building Ubuntu packages from source</h4>
<p>Most people won't need to do this, but just in case, here's how to build our Ubuntu packages:</p>
<ol>
<li>
<p>
Make sure you have the necessary build tools installed:
aptitude install kernel-package ncurses-dev fakeroot libldap2-dev slang1-dev libevent-dev libkrb53 libkrb5-dev libc6-dev subversion
</p>
</li>
<li>
<p>
Get the latest code: svn checkout http://zumastor.googlecode.com/svn/trunk/ zumastor
</p>
</li>
<li>
<p>
Run the build script: cd zumastor; ./buildcurrent kernel/config/full
This builds three Debian packages: one for the kernel, one for ddsnap, and one for zumastor.
It will download the required kernel tarball from kernel.org (currently 2.6.22.10).
Note: The script takes a parameter which is a .config file for the kernel.  There is distribution-like config in the repository in kernel/config/full.  If you need to use a different config, make sure you enable CONFIG_DM_DDSNAP to be (y or m)
</p>
</li>
</ol>
<p>(Also, pcquiles mentioned in <a href="http://zumastor.org/irclogs/2007-12-04.txt">irc</a> that he is working on Ubuntu packaging for a Xen+Zumastor kernel; if you were thinking of integrating Zumastor into upstream Debian or Ubuntu, check out his work first.)</p>
<h4>8.1.4. Exporting a Zumastor volume via NFS</h4>
<ol>
<li>
<p>
Install Zumastor using one of the methods above.
</p>
</li>
<li>
<p>
Install the NFS server packages:
</p>
<div class="listingblock">
<div class="content">
<pre><tt># aptitude install nfs-common nfs-kernel-server</tt></pre>
</div></div>
</li>
<li>
<p>
Obtain and apply the Zumastor patch to <tt>/etc/init.d/nfs-kernel-server</tt>.
</p>
<div class="listingblock">
<div class="content">
<pre><tt># cd /etc/init.d/
# wget http://zumastor.googlecode.com/svn/trunk/zumastor/nfs-patches/debian/nfs-kernel-server.patch
# patch -p0 &lt; nfs-kernel-server.patch
# rm -f nfs-kernel-server.patch</tt></pre>
</div></div>
</li>
<li>
<p>
Add the following lines to the NFS exports file <tt>/etc/exports</tt>
(where <em>testvol</em> is the Zumastor volume to be exported):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>/var/run/zumastor/mount/testvol *(rw,fsid=0,nohide,no_subtree_check)
/var/run/zumastor/mount/testvol.snapshots *(ro,fsid=1,nohide,no_subtree_check)</tt></pre>
</div></div>
<p>The &#8220;fsid=xxx&#8221; option is required to ensure that the NFS server uses the same
file handle after a restart or remount of an exported volume.  If it is not
specified, when the snapshot is remounted the file handle will change and the
client will receive a stale file handle error. Any 32 bit number can be used for
fsid value but it must be unique across all exported filesystems.</p>
</li>
</ol>
<p>To export zumastor volumes from a different path, symlink the zumastor volumes
to that path and add it to <tt>/etc/exports</tt>.</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">A future revision of Zumastor may allow you to specify an arbitrary mount
point, eliminating the need for this symlink.</td>
</tr></table>
</div>
<h3>8.2. Gentoo</h3>
<p>The Zumastor project has a Gentoo overlay to simplify deployment of
Zumastor using Gentoo's Portage package system. To use the overlay in
an automated fashion you'll want to make sure you have the Gentoo
overlay manager, layman, installed.</p>
<div class="literalblock">
<div class="content">
<pre><tt># emerge layman
# echo "source /usr/portage/local/layman/make.conf" &gt;&gt; /etc/make.conf</tt></pre>
</div></div>
<p>Next you'll want to add the Zumastor overlay diretory to layman's
/etc/layman/layman.cfg. You want to update the "overlays"
variable. Note that layman's config format want's each new entry in
the overlays list to be on a new line. After you have updated it, the
section of the file where overlays is set will look something like:</p>
<div class="literalblock">
<div class="content">
<pre><tt>overlays        : http://www.gentoo.org/proj/en/overlays/layman-global.txt
                  http://zumastor.googlecode.com/svn/trunk/gentoo/overlay/overlays.xml</tt></pre>
</div></div>
<p>You will then want to add the Zumastor overlay to layman:</p>
<div class="literalblock">
<div class="content">
<pre><tt># layman -f -a zumastor</tt></pre>
</div></div>
<p>The zumastor ebuilds are currently masked, so the next think you'll
need to do is to unmask them:</p>
<div class="literalblock">
<div class="content">
<pre><tt># echo "sys-kernel/zumastor-sources ~x86" &gt;&gt; /etc/portage/package.keywords
# echo "sys-block/zumastor ~x86" &gt;&gt; /etc/portage/package.keywords</tt></pre>
</div></div>
<p>After all that preamble, we are now ready to install Zumastor and the
Zumastor kernel sources:</p>
<div class="literalblock">
<div class="content">
<pre><tt># emerge zumastor-sources zumastor</tt></pre>
</div></div>
<p>Congratulations, you have now installed the zumastor software and
kernel sources. You'll need to build a kernel as per usual, with one
exception: you need to ensure that you enable the CONFIG_DM_DDSNAP
kernel option when you configure your kernel. It can be found in
"Device Drivers" -&gt; "Multi-device support" -&gt; "Distributed Data
Snapshot target".</p>
<p>The Zumastor project also recommends a few options be enabled to
assist with debugging: CONFIG_IKCONFIG_PROC, CONFIG_MAGIC_SYSRQ, and
CONFIG_DEBUG_INFO.</p>
<h4>8.2.1. Example: installing Zumastor on Gentoo inside a VMWare player</h4>
<p>We have a prebuilt Gentoo vmware image at
<a href="http://zumastor.org/downloads/misc/Gentoo_VMImage.tar.7z">http://zumastor.org/downloads/misc/Gentoo_VMImage.tar.7z</a>.  You'll
need to unpack that image with 7zip (believe it or not, compressing
with 7zip saved a lot more space than with rzip, and lrzip crashed on
it.  Go figure.)</p>
<p>Be sure to check the settings to make sure that the RAM allocation is
reasonable for your system. When you look at the settings you'll
notice there are two SCSI drives installed on the image. The first one
contains the Gentoo image, and the second is a blank, set aside for
your Zumastor datastore. You may wish to resize the second one to
better suit your needs.</p>
<p>Power on the virtual image and select the Zumastor kernel. The root
password on the image is set to "zumastor", so you should login as
root and immediately change the password. You should also look at the
contents of /etc/conf.d/clock to make sure that the timezone and clock
settings are correct for your system. I'd also recommend syncing and
updating through portage/layman, just to be sure you have the latest
software.</p>
<p>Once you've got the image the way you want it, it is time to set up
the Zumastor storage space. You'll need to use lvm to create a
physical volume and volume group:</p>
<div class="literalblock">
<div class="content">
<pre><tt># pvcreate /dev/sdb
# vgcreate sysvg /dev/sdb
# lvcreate --size 500MB -n test sysvg
# lvcreate --size 1500MB -n test sysvg</tt></pre>
</div></div>
<p>Your Gentoo image is now ready for Zumastor.</p>
<h3>8.3. Source</h3>
<p>If you use a distro not covered above, you can install if you're
willing to patch your kernel and compile everything manually.  See
the writeup at <a href="http://zumastor.googlecode.com/svn/trunk/ddsnap/INSTALL">http://zumastor.googlecode.com/svn/trunk/ddsnap/INSTALL</a>.</p>
<h3>8.4. UML</h3>
<p>Developers who wish to contribute changes to Zumastor should
make sure that our UML test suite passes before and after
their changes.  The UML test suite is in our SVN tree under
tests/uml.  The file to run there is <strong><a href="http://zumastor.googlecode.com/svn/trunk/test/uml/demo.sh">demo.sh</a></strong>.
See also <a href="http://zumastor.org/demo-uml-ubuntu.html">http://zumastor.org/demo-uml-ubuntu.html</a>.</p>
</div>
<h2>9. Examples</h2>
<div class="sectionbody">
<h3>9.1. Verify that LVM2 is installed</h3>
<p>Many of these examples require LVM, so install that first if it's not already.
(This example is for Debian / Ubuntu, but it's similar for Fedora et al.)</p>
<div class="literalblock">
<div class="content">
<pre><tt>$ sudo apt-get install lvm2
$ sudo /etc/init.d/lvm start
$ pvcreate</tt></pre>
</div></div>
<p>If pvcreate complains No program "pvcreate" found for your current version of LVM, you probably forgot to start the lvm service.</p>
<h3>9.2. Verify that Zumastor is installed and started</h3>
<div class="literalblock">
<div class="content">
<pre><tt>$ zumastor
Usage: /bin/zumastor {define|forget|start|stop|snapshot|replicate|status} [&lt;subarguments&gt;...]</tt></pre>
</div></div>
<p>Note: this doesn't yet complain properly if you forgot to reboot
into a kernel that supports zumastor.  (It will later, when you try to
define a volume.)</p>
<h3>9.3. Create a simple snapshotted volume on a loopback file</h3>
<p>Before you go messing with real devices, it's useful
to experiment with plain old files dressed up to look
like devices via the loopback device.</p>
<p>Annoyingly, the loopback device naming scheme changed at some point;
on some systems it's /dev/loop/0, on others it's /dev/loop0.
You may need to adjust the path to suit your version of Linux.</p>
<div class="literalblock">
<div class="content">
<pre><tt># dd if=/dev/zero of=/media/vg.img bs=1024 count=220000
# losetup -d /dev/loop/0 || true
# losetup /dev/loop/0 /media/vg.img
# pvcreate /dev/loop/0
# vgcreate sysvg /dev/loop/0
# lvcreate --name test --size 100MB sysvg
# lvcreate --name test_snap --size 100MB sysvg
# zumastor define volume zumatest /dev/sysvg/test /dev/sysvg/test_snap --initialize</tt></pre>
</div></div>
<p>If this complains</p>
<div class="literalblock">
<div class="content">
<pre><tt>/bin/zumastor[889]: error: dmsetup returned 1
create failed
/bin/zumastor: define volume 'zumatest' failed</tt></pre>
</div></div>
<p>you may have forgotten to reboot into the Zumastor-enabled kernel
you installed earlier.</p>
<h3>9.4. What if Zumastor can't mount the devices at boot time?</h3>
<p>Starting with the previous example,
reboot the virtual machine and log back in as root.
Notice that df doesn't show any Zumastor volumes mounted.
That's because when Zumastor started at boot time, it
couldn't see the loopback device, because we didn't arrange
for it to be set up automatically at boot time.
(This won't happen with real devices!)
So do it manually now, then tell LVM about it, then tell Zumastor about it:</p>
<div class="literalblock">
<div class="content">
<pre><tt>$ sudo sh
# losetup /dev/loop/0 /media/vg.img
# vgchange -ay
# bash /etc/init.d/zumastor restart
# df | grep zumatest</tt></pre>
</div></div>
<p>You should now see the expected set of volumes and snapshots mounted.</p>
<p>If vgchange -ay doesn't detect your volume group, do rm /etc/lvm/.cache
and try again.</p>
<h3>9.5. Remove the volume and loopback file created above</h3>
<div class="literalblock">
<div class="content">
<pre><tt># zumastor forget volume zumatest
# lvremove sysvg
# losetup -d /dev/loop/0
# rm /media/vg.img</tt></pre>
</div></div>
<h3>9.6. Create a single snapshotted volume on a real device</h3>
<p>Find an big empty partition. Let's say it's a 10GB /dev/hda3.
Here's how to use LVM to put a volume and its snapshot store onto it:</p>
<div class="literalblock">
<div class="content">
<pre><tt># pvcreate /dev/hda3
  Physical volume "/dev/hda3" successfully created
# vgcreate sysvg /dev/hda3
  Volume group "sysvg" successfully created
# lvcreate --name test --size 5G sysvg
  Logical volume "test" created
# lvcreate --name test_snap --size 5G sysvg
  Logical volume "test_snap" created
# zumastor define volume zumatest /dev/sysvg/test /dev/sysvg/test_snap --initialize
Wed Nov 21 19:32:58 2007: [3622] snap_server_setup: ddsnapd bound to socket /var/run/zumastor/servers/zumatest
pid = 3623
Successfully created and initialized volume 'zumatest'.
# mkfs.ext3 /dev/mapper/zumatest</tt></pre>
</div></div>
<p>You now have an unmounted filesystem which can be snapshotted.</p>
<h3>9.7. Mount a new volume and set up periodic snapshots</h3>
<p>To mount the new volume you created in the previous example,
and set up hourly snapshots, do:</p>
<div class="literalblock">
<div class="content">
<pre><tt># zumastor define master zumatest --hourly 24</tt></pre>
</div></div>
<p>Setting this volume as a "master" causes it be to mounted on
/var/run/zumastor/mount/zumatest.
The &#8212;hourly 24 specifies that we want to keep the 24 most recent hourly snapshots (a days worth).
A snapshot will be created once an hour via the zumastor hourly cron
script.  We can accelerate this by manually telling zumastor to take an
"hourly" snapshot right now, with the zumastor snapshot command:</p>
<div class="literalblock">
<div class="content">
<pre><tt># zumastor snapshot zumatest hourly
# df | grep zumatest
/dev/mapper/zumatest  5160576    131228   4767204   3% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  5160576    131228   4767204   3% /var/run/zumastor/mount/zumatest(0)</tt></pre>
</div></div>
<p>If you do some IO on the filesystem you should notice only the origin device, mounted on /var/run/zumastor/mount/zumatest changes:</p>
<div class="literalblock">
<div class="content">
<pre><tt># echo "This is the first file!" &gt; /var/run/zumastor/zumatest/foo.txt
# df | grep zumatest
/dev/mapper/zumatest  99150       4128   89902   5% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  99150    4127   89903   5% /var/run/zumastor/mount/zumatest(0)</tt></pre>
</div></div>
<p>As expected, the origin's "Used" block count goes up by one,
but the snapshot's doesn't change.</p>
<p>Now take another snapshot, and look at df again:</p>
<div class="literalblock">
<div class="content">
<pre><tt># zumastor snapshot zumatest hourly
# df | grep zumatest
/dev/mapper/zumatest  99150    4128   89902   5% /var/run/zumastor/mount/zumatest
/dev/mapper/zumatest(0)  99150    4127   89903   5% /var/run/zumastor/mount/zumatest(0)
/dev/mapper/zumatest(2)  99150    4128   89902   5% /var/run/zumastor/mount/zumatest(0)</tt></pre>
</div></div>
<p>Notice that the first snapshot was named</p>
<p>zumatest(0), but the new one is named zumatest(2).
(Why the gap?  Zumastor uses another snapshot internally during
replication.  Yes, this is a bit of a rough edge.)</p>
<h3>9.8. Where do old snapshots go?</h3>
<p>Assuming you've set up a volume to keep 24 hourly snapshots
around with the command zumastor define master zumatest &#8212;hourly 24
as in the last example, what happens when the 25th snapshot is taken?</p>
<p>To find out, you can run a loop that takes lots of snapshots.
Run it, then use df to see how many snapshots are around afterwards:</p>
<div class="literalblock">
<div class="content">
<pre><tt># num=0
# while test $num -lt 50
  do
    zumastor snapshot zumatest hourly
    num=`expr $num + 1`
    echo $num
  done
# df -P | grep zumatest</tt></pre>
</div></div>
<p>You should see 24 snapshots (the limit set when we did the zumastor define master)
plus the origin volume.  Each time you run zumastor snapshot &#8230;
it creates a new snapshot, and deletes any that are <em>too old</em>.</p>
</div>
<div id="footer">
<div id="footer-text">
Version 0.0<br />
Last updated 10-Dec-2007 11:41:33 PDT
</div>
</div>
</body>
</html>
